<!DOCTYPE html>
<html>
<head>
    <title>ç½‘æ˜“äº‘éŸ³ä¹</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: sans-serif; background: #f8f9fa; margin: 0; padding: 15px; }
        .search-box { position: sticky; top: 0; background: #f8f9fa; padding: 10px 0; display: flex; gap: 5px; z-index: 100; }
        input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px; outline: none; }
        button.search-btn { padding: 10px 20px; background: #ff3a3a; color: white; border: none; border-radius: 8px; font-weight: bold; }
        
        .song-item { background: white; margin-top: 10px; padding: 12px; border-radius: 10px; display: flex; flex-direction: column; gap: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .song-info { overflow: hidden; }
        .song-name { font-weight: bold; color: #333; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .song-artist { font-size: 0.85em; color: #666; margin-top: 4px; }
        
        .btn-group { display: flex; gap: 8px; width: 100%; }
        .play-btn { background: #4caf50; color: white; border: none; padding: 10px; border-radius: 5px; flex: 1; font-size: 0.8em; }
        .dl-btn { background: #2196f3; color: white; border: none; padding: 10px; border-radius: 5px; flex: 1; font-size: 0.8em; }
        .lrc-btn { background: #9c27b0; color: white; border: none; padding: 10px; border-radius: 5px; flex: 1; font-size: 0.8em; }
        
        #player-container { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 15px; border-top: 1px solid #eee; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); }
        audio { width: 100%; height: 40px; }
    </style>
</head>
<body>

    <div class="search-box">
        <input type="text" id="keyword" placeholder="è¾“å…¥æ­Œåæˆ–æ­Œæ‰‹" onkeypress="if(event.keyCode==13) search()">
        <button class="search-btn" onclick="search()">æœç´¢</button>
    </div>

    <div id="result-list" style="padding-bottom: 120px;">
        <p style="text-align:center; color:#999; margin-top:30px;">ç­‰å¾…æœç´¢ (Termux 127.0.0.1:3000)</p>
    </div>

    <div id="player-container">
        <div id="now-playing" style="font-size: 0.85em; margin-bottom: 8px; color: #333; text-align: center; font-weight: bold;">å°±ç»ª</div>
        <audio id="mainPlayer" controls></audio>
    </div>

    <script>
        const BASE_URL = "http://127.0.0.1:3000";

        async function search() {
            const kw = document.getElementById('keyword').value;
            if(!kw) return;
            const listDiv = document.getElementById('result-list');
            listDiv.innerHTML = '<p style="text-align:center">ğŸ” æœç´¢ä¸­...</p>';

            try {
                const res = await fetch(`${BASE_URL}/search?keywords=${encodeURIComponent(kw)}`);
                const data = await res.json();
                const songs = data.result?.songs || data.data?.songs || [];
                
                if (songs.length === 0) {
                    listDiv.innerHTML = '<p style="text-align:center">âŒ æœªæ‰¾åˆ°ç»“æœ</p>';
                    return;
                }
                
                listDiv.innerHTML = ''; 
                songs.forEach(song => {
                    const artistsArr = song.ar || song.artists || [{name: 'æœªçŸ¥'}];
                    const artists = artistsArr.map(a => a.name).join(' / ');
                    const safeName = (song.name || "æœªçŸ¥").replace(/'/g, "\\'");
                    const safeArtist = artists.replace(/'/g, "\\'");

                    const item = document.createElement('div');
                    item.className = 'song-item';
                    item.innerHTML = `
                        <div class="song-info">
                            <span class="song-name">${song.name}</span>
                            <span class="song-artist">${artists}</span>
                        </div>
                        <div class="btn-group">
                            <button class="play-btn" onclick="playSong(${song.id}, '${safeName}')">æ’­æ”¾</button>
                            <button class="dl-btn" onclick="downloadMusic(${song.id}, '${safeName}', '${safeArtist}')">ä¸‹éŸ³é¢‘</button>
                            <button class="lrc-btn" onclick="downloadLyric(${song.id}, '${safeName}', '${safeArtist}')">ä¸‹å¯¹ç…§æ­Œè¯</button>
                        </div>
                    `;
                    listDiv.appendChild(item);
                });
            } catch (e) {
                listDiv.innerHTML = '<p style="text-align:center; color:red;">è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ Termux æœåŠ¡</p>';
            }
        }

        async function playSong(id, name) {
            try {
                const res = await fetch(`${BASE_URL}/song/url/v1?id=${id}&level=standard`);
                const data = await res.json();
                const url = data.data?.[0]?.url;
                if(!url) return alert('æ— æ³•æ’­æ”¾');
                const player = document.getElementById('mainPlayer');
                document.getElementById('now-playing').innerText = 'é¢„è§ˆä¸­: ' + name;
                player.src = url;
                player.play();
            } catch (e) { alert('æ’­æ”¾å‡ºé”™'); }
        }

        async function downloadMusic(id, name, artist) {
            const fileName = `${name} - ${artist}`.replace(/[\/\\:*?"<>|]/g, '');
            try {
                const res = await fetch(`${BASE_URL}/song/url/v1?id=${id}&level=standard`);
                const data = await res.json();
                const url = data.data?.[0]?.url;
                if(!url) return alert('è·å–åœ°å€å¤±è´¥');

                const a = document.createElement('a');
                a.href = url;
                a.download = `${fileName}.mp3`;
                a.click();
            } catch (e) { alert('ä¸‹è½½éŸ³é¢‘å¤±è´¥'); }
        }

        // æ ¸å¿ƒï¼šä¸‹è½½ä¸­è‹±/ä¸­å¤–åŒè¯­å¯¹ç…§æ­Œè¯
        async function downloadLyric(id, name, artist) {
            const fileName = `${name} - ${artist}`.replace(/[\/\\:*?"<>|]/g, '');
            try {
                const res = await fetch(`${BASE_URL}/lyric?id=${id}`);
                const data = await res.json();
                
                const originLrc = data.lrc?.lyric || '';
                const transLrc = data.tlyric?.lyric || '';
                
                if (!originLrc) return alert('æ­¤æ­Œæ›²æš‚æ— æ­Œè¯');

                // å¦‚æœæœ‰ç¿»è¯‘ï¼Œæ‰§è¡Œåˆå¹¶é€»è¾‘ï¼›å¦åˆ™ç›´æ¥ä½¿ç”¨åŸæ–‡
                const finalLrc = transLrc ? mergeLyrics(originLrc, transLrc) : originLrc;

                const blob = new Blob([finalLrc], { type: 'text/lrc' });
                const lrcUrl = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = lrcUrl;
                a.download = `${fileName}.lrc`;
                a.click();
                URL.revokeObjectURL(lrcUrl);
            } catch (e) { alert('æ­Œè¯å¤„ç†å‡ºé”™'); }
        }

        // æ­Œè¯åˆå¹¶å‡½æ•°ï¼šé€šè¿‡ Map æŒ‰æ—¶é—´è½´ç²¾å‡†åŒ¹é…
        function mergeLyrics(origin, trans) {
            const parseLrc = (text) => {
                const map = new Map();
                const lines = text.split('\n');
                lines.forEach(line => {
                    const match = line.match(/^\[(\d{2}:\d{2}\.\d{2,3})\](.*)/);
                    if (match) map.set(match[1], match[2].trim());
                });
                return map;
            };

            const originMap = parseLrc(origin);
            const transMap = parseLrc(trans);
            
            // è·å–æ‰€æœ‰ä¸é‡å¤çš„æ—¶é—´ç‚¹å¹¶æ’åº
            const allTimeTags = Array.from(new Set([...originMap.keys(), ...transMap.keys()])).sort();
            
            return allTimeTags.map(tag => {
                const oText = originMap.get(tag) || '';
                const tText = transMap.get(tag) || '';
                // åªæœ‰åŸæ–‡å’Œè¯‘æ–‡éƒ½æœ‰å†…å®¹æ—¶æ‰ç”¨æ–œæ è¿æ¥ï¼Œå¦åˆ™å±•ç¤ºæœ‰çš„é‚£éƒ¨åˆ†
                const content = (oText && tText) ? `${oText} / ${tText}` : (oText || tText);
                return `[${tag}]${content}`;
            }).join('\n');
        }
    </script>
</body>
</html>
